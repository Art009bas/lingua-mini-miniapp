<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles */
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: contain;
        }
        
        #camera-feed {
            transform: scaleX(-1); /* Mirror effect */
        }
        
        .video-thumbnail {
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .video-thumbnail:active {
            transform: scale(0.98);
        }
        
        .recording-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Fullscreen modal */
        .modal {
            transition: opacity 0.3s ease;
            pointer-events: none;
            opacity: 0;
        }
        
        .modal.active {
            pointer-events: auto;
            opacity: 1;
        }
        
        /* Video player controls */
        .video-controls {
            transition: opacity 0.3s ease;
        }
        
        .video-player:hover .video-controls {
            opacity: 1;
        }
        
        /* Progress bar */
        .progress-bar {
            height: 3px;
        }
        
        .progress-filled {
            width: 0%;
        }
        
        /* Swipeable area */
        .swipe-area {
            touch-action: pan-y;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Main App Screen -->
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">My Videos</h1>
            <button id="new-recording-btn" class="bg-blue-500 text-white p-3 rounded-full shadow-md">
                <i class="fas fa-plus"></i>
            </button>
        </header>
        
        <!-- Video History Grid -->
        <div id="video-history" class="grid grid-cols-2 gap-3">
            <div class="text-center py-10 text-gray-400" id="empty-history-message">
                <i class="fas fa-video text-3xl mb-2"></i>
                <p>No videos yet</p>
            </div>
            <!-- Videos will be added here dynamically -->
        </div>
    </div>
    
    <!-- Recording Modal (Fullscreen) -->
    <div id="recording-modal" class="modal fixed inset-0 bg-white z-50 flex flex-col">
        <!-- Camera Preview -->
        <div class="flex-1 relative">
            <video id="camera-feed" autoplay playsinline class="w-full h-full object-cover"></video>
            
            <!-- Recording Indicator -->
            <div id="recording-status" class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm hidden items-center">
                <i class="fas fa-circle recording-indicator mr-2"></i>
                <span id="recording-time">00:00</span>
            </div>
            
            <!-- Close Button -->
            <button id="close-recording" class="absolute top-4 right-4 bg-white bg-opacity-80 text-gray-800 p-2 rounded-full">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Controls -->
        <div class="bg-white py-4 px-6 flex flex-col items-center border-t border-gray-100">
            <!-- Record Button -->
            <button id="record-btn" class="bg-red-500 text-white p-5 rounded-full shadow-lg mb-4">
                <i class="fas fa-circle text-xl"></i>
            </button>
            
            <!-- Timer -->
            <div class="text-gray-500 text-sm mb-2 hidden" id="recording-timer">00:00</div>
            
            <!-- Flip Camera -->
            <button id="flip-camera" class="absolute left-6 bottom-6 bg-white bg-opacity-80 text-gray-800 p-3 rounded-full shadow">
                <i class="fas fa-camera-rotate"></i>
            </button>
        </div>
    </div>
    
    <!-- Video Player Modal (Fullscreen) -->
    <div id="video-player-modal" class="modal fixed inset-0 bg-black z-50 flex flex-col">
        <div class="flex-1 relative video-player">
            <video id="video-player" class="w-full h-full object-contain"></video>
            
            <!-- Close Button -->
            <button id="close-player" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white p-3 rounded-full">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Video Controls -->
            <div class="video-controls absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4 opacity-0 transition-opacity">
                <!-- Progress Bar -->
                <div class="progress-bar bg-gray-600 rounded-full mb-3">
                    <div class="progress-filled bg-blue-500 h-full rounded-full"></div>
                </div>
                
                <div class="flex justify-between items-center">
                    <!-- Current Time -->
                    <span id="current-time" class="text-white text-sm">00:00</span>
                    
                    <!-- Play/Pause Button -->
                    <button id="play-pause" class="bg-white bg-opacity-20 text-white p-3 rounded-full">
                        <i class="fas fa-play"></i>
                    </button>
                    
                    <!-- Duration -->
                    <span id="duration" class="text-white text-sm">00:00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const videoHistory = document.getElementById('video-history');
            const emptyHistoryMessage = document.getElementById('empty-history-message');
            const newRecordingBtn = document.getElementById('new-recording-btn');
            const recordingModal = document.getElementById('recording-modal');
            const videoPlayerModal = document.getElementById('video-player-modal');
            const closeRecording = document.getElementById('close-recording');
            const closePlayer = document.getElementById('close-player');
            
            // Camera elements
            const cameraFeed = document.getElementById('camera-feed');
            const recordBtn = document.getElementById('record-btn');
            const recordingStatus = document.getElementById('recording-status');
            const recordingTime = document.getElementById('recording-time');
            const recordingTimer = document.getElementById('recording-timer');
            const flipCamera = document.getElementById('flip-camera');
            
            // Video player elements
            const videoPlayer = document.getElementById('video-player');
            const playPauseBtn = document.getElementById('play-pause');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const progressBar = document.querySelector('.progress-bar');
            const progressFilled = document.querySelector('.progress-filled');
            
            // Variables
            let stream = null;
            let mediaRecorder = null;
            let recordedChunks = [];
            let currentDeviceId = null;
            let cameras = [];
            let recordingInterval = null;
            let recordingSeconds = 0;
            let videoHistoryData = JSON.parse(localStorage.getItem('videoHistory')) || [];
            let isFrontCamera = true;
            let touchStartX = 0;
            let touchEndX = 0;
            
            // Initialize the app
            init();
            
            function init() {
                // Load video history
                renderVideoHistory();
                
                // Event listeners
                newRecordingBtn.addEventListener('click', openRecordingModal);
                closeRecording.addEventListener('click', closeRecordingModal);
                closePlayer.addEventListener('click', closeVideoPlayer);
                recordBtn.addEventListener('click', toggleRecording);
                flipCamera.addEventListener('click', switchCamera);
                
                // Video player controls
                playPauseBtn.addEventListener('click', togglePlayPause);
                videoPlayer.addEventListener('timeupdate', updateProgressBar);
                videoPlayer.addEventListener('click', toggleVideoControls);
                videoPlayer.addEventListener('ended', videoEnded);
                
                // Progress bar click
                progressBar.addEventListener('click', seek);
                
                // Touch events for swipe gestures
                videoPlayer.addEventListener('touchstart', handleTouchStart, false);
                videoPlayer.addEventListener('touchmove', handleTouchMove, false);
                videoPlayer.addEventListener('touchend', handleTouchEnd, false);
            }
            
            // Render video history as grid
            function renderVideoHistory() {
                if (videoHistoryData.length === 0) {
                    emptyHistoryMessage.classList.remove('hidden');
                    return;
                }
                
                emptyHistoryMessage.classList.add('hidden');
                videoHistory.innerHTML = '';
                
                videoHistoryData.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-thumbnail bg-white rounded-lg overflow-hidden';
                    videoItem.innerHTML = `
                        <div class="relative pb-[56.25%]">
                            <video src="${video.url}" class="absolute top-0 left-0 w-full h-full object-cover"></video>
                            <div class="absolute bottom-1 right-1 bg-black bg-opacity-70 text-white text-xs px-1 rounded">
                                ${formatDuration(video.duration)}
                            </div>
                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 hover:bg-opacity-20 transition">
                                <i class="fas fa-play text-white text-2xl opacity-0 hover:opacity-100 transition"></i>
                            </div>
                        </div>
                        <div class="p-2">
                            <div class="text-xs text-gray-500">${formatDate(video.timestamp)}</div>
                        </div>
                    `;
                    
                    videoItem.addEventListener('click', () => playVideo(video));
                    videoHistory.appendChild(videoItem);
                });
            }
            
            // Open recording modal
            async function openRecordingModal() {
                recordingModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: isFrontCamera ? 'user' : 'environment'
                        },
                        audio: true
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraFeed.srcObject = stream;
                    
                    // Initialize media recorder
                    initMediaRecorder();
                    
                    // Get current device ID
                    const track = stream.getVideoTracks()[0];
                    currentDeviceId = track.getSettings().deviceId;
                    
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Could not access the camera. Please make sure you've granted camera and microphone permissions.");
                    closeRecordingModal();
                }
            }
            
            // Close recording modal
            function closeRecordingModal() {
                // Stop recording if active
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    stopRecording();
                }
                
                // Stop camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    cameraFeed.srcObject = null;
                }
                
                recordingModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            // Initialize media recorder
            function initMediaRecorder() {
                if (!stream) return;
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = function(e) {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    const blob = new Blob(recordedChunks, { type: 'video/mp4' });
                    const videoUrl = URL.createObjectURL(blob);
                    
                    // Add to history
                    const videoData = {
                        id: Date.now(),
                        url: videoUrl,
                        timestamp: new Date().toISOString(),
                        duration: recordingSeconds
                    };
                    
                    videoHistoryData.unshift(videoData);
                    localStorage.setItem('videoHistory', JSON.stringify(videoHistoryData));
                    renderVideoHistory();
                    
                    // Reset recording
                    recordedChunks = [];
                    recordingSeconds = 0;
                };
            }
            
            // Toggle recording
            function toggleRecording() {
                if (!mediaRecorder) return;
                
                if (mediaRecorder.state === 'inactive') {
                    startRecording();
                } else {
                    mediaRecorder.stop();
                    stopRecording();
                }
            }
            
            // Start recording
            function startRecording() {
                if (!mediaRecorder) return;
                
                mediaRecorder.start(100); // Collect data every 100ms
                recordingStatus.classList.remove('hidden');
                recordBtn.innerHTML = '<i class="fas fa-square text-xl"></i>';
                recordingTimer.classList.remove('hidden');
                
                // Start timer
                recordingSeconds = 0;
                updateRecordingTime();
                recordingInterval = setInterval(updateRecordingTime, 1000);
            }
            
            // Stop recording
            function stopRecording() {
                if (!mediaRecorder) return;
                
                recordingStatus.classList.add('hidden');
                recordBtn.innerHTML = '<i class="fas fa-circle text-xl"></i>';
                recordingTimer.classList.add('hidden');
                
                // Stop timer
                if (recordingInterval) {
                    clearInterval(recordingInterval);
                    recordingInterval = null;
                }
            }
            
            // Update recording time
            function updateRecordingTime() {
                recordingSeconds++;
                const minutes = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
                const seconds = (recordingSeconds % 60).toString().padStart(2, '0');
                recordingTime.textContent = `${minutes}:${seconds}`;
                recordingTimer.textContent = `${minutes}:${seconds}`;
            }
            
            // Switch camera
            async function switchCamera() {
                if (!stream) return;
                
                // Stop current stream and recording if active
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    stopRecording();
                }
                
                stream.getTracks().forEach(track => track.stop());
                isFrontCamera = !isFrontCamera;
                
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: isFrontCamera ? 'user' : 'environment'
                        },
                        audio: true
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraFeed.srcObject = stream;
                    
                    // Reinitialize media recorder with new stream
                    initMediaRecorder();
                    
                } catch (err) {
                    console.error("Error switching camera:", err);
                    alert("Could not switch camera. Please try again.");
                }
            }
            
            // Play video in fullscreen
            function playVideo(video) {
                videoPlayerModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                videoPlayer.src = video.url;
                videoPlayer.play();
                
                // Update duration
                setTimeout(() => {
                    durationEl.textContent = formatDuration(videoPlayer.duration);
                }, 100);
                
                // Show controls briefly
                showVideoControls();
                setTimeout(hideVideoControls, 2000);
            }
            
            // Close video player
            function closeVideoPlayer() {
                videoPlayer.pause();
                videoPlayerModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            // Toggle play/pause
            function togglePlayPause() {
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    videoPlayer.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            }
            
            // Update progress bar
            function updateProgressBar() {
                const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                progressFilled.style.width = `${percent}%`;
                currentTimeEl.textContent = formatDuration(videoPlayer.currentTime);
            }
            
            // Seek on progress bar click
            function seek(e) {
                const percent = e.offsetX / progressBar.offsetWidth;
                videoPlayer.currentTime = percent * videoPlayer.duration;
            }
            
            // Video ended
            function videoEnded() {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
            
            // Show video controls
            function showVideoControls() {
                document.querySelector('.video-controls').style.opacity = '1';
            }
            
            // Hide video controls
            function hideVideoControls() {
                if (!videoPlayer.paused) {
                    document.querySelector('.video-controls').style.opacity = '0';
                }
            }
            
            // Toggle video controls
            function toggleVideoControls() {
                const controls = document.querySelector('.video-controls');
                if (controls.style.opacity === '1') {
                    hideVideoControls();
                } else {
                    showVideoControls();
                }
            }
            
            // Touch events for swipe gestures
            function handleTouchStart(e) {
                touchStartX = e.changedTouches[0].screenX;
            }
            
            function handleTouchMove(e) {
                e.preventDefault(); // Prevent scrolling while swiping
            }
            
            function handleTouchEnd(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }
            
            // Handle swipe gestures
            function handleSwipe() {
                const threshold = 50; // Minimum swipe distance
                const diff = touchStartX - touchEndX;
                
                // Left swipe (next)
                if (diff > threshold) {
                    // Seek forward 10 seconds
                    videoPlayer.currentTime = Math.min(videoPlayer.currentTime + 10, videoPlayer.duration);
                }
                // Right swipe (previous)
                else if (diff < -threshold) {
                    // Seek backward 10 seconds
                    videoPlayer.currentTime = Math.max(videoPlayer.currentTime - 10, 0);
                }
                
                // Show controls after swipe
                showVideoControls();
            }
            
            // Helper functions
            function formatDuration(seconds) {
                if (!seconds) return '00:00';
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            }
            
            function formatDate(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        });
    </script>
</body>
</html>
